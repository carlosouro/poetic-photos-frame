<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poetic Memories</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;1,300&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; color: #fff; overflow: hidden;
            font-family: 'Merriweather', serif; user-select: none;
            
            /* HIDE CURSOR BY DEFAULT */
            cursor: none; 
        }

        #app { position: relative; width: 100vw; height: 100vh; }

        /* PHOTO LAYER */
        #photo-container {
            width: 100%; height: 100%; display: flex;
            justify-content: center; align-items: center; background: #000;
        }
        #main-photo {
            max-width: 100%; max-height: 100%; object-fit: contain; 
            opacity: 0; transition: opacity 1.5s ease-in-out;
        }

        /* TEXT OVERLAY */
        #text-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; min-height: 25vh; 
            background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.6) 60%, rgba(0,0,0,0) 100%);
            display: flex; flex-direction: column; justify-content: flex-end; 
            align-items: center; padding-bottom: 20px; z-index: 10; pointer-events: none;
        }
        #content-wrapper { width: 80%; text-align: center; margin-bottom: 30px; pointer-events: none; }
        #poem-text {
            font-size: 1.8rem; font-style: italic; line-height: 1.4; color: #f0f0f0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); opacity: 0; transition: opacity 2s ease-in-out 0.5s;
        }
        #author-text {
            font-family: 'Montserrat', sans-serif; font-size: 0.9rem; color: #aaa;
            text-transform: uppercase; letter-spacing: 2px; margin-top: 15px;
            opacity: 0; transition: opacity 2s ease-in-out 0.8s;
        }
        #date-display {
            position: absolute; bottom: 25px; right: 30px;
            font-family: 'Montserrat', sans-serif; font-size: 0.85rem; color: #888;
            letter-spacing: 1px; opacity: 0; transition: opacity 2s ease-in-out 1s;
        }
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #333; font-family: sans-serif; transition: opacity 0.5s;
        }

        /* MENU STYLES */
        #menu-overlay, #delete-confirm-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px); opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
            
            /* SHOW CURSOR WHEN MENUS ARE OPEN */
            cursor: default;
        }
        .overlay-visible { opacity: 1 !important; pointer-events: auto !important; }

        #menu-box {
            background: #1a1a1a; padding: 25px; border-radius: 15px; border: 1px solid #333;
            display: flex; flex-direction: column; gap: 15px; min-width: 280px;
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .menu-title { font-family: 'Montserrat', sans-serif; font-size: 1.2rem; color: #fff; margin-bottom: 5px; text-transform: uppercase; }

        .btn {
            padding: 12px 20px; font-family: 'Montserrat', sans-serif; font-size: 1rem;
            border: none; border-radius: 8px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; gap: 10px; font-weight: 600;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-fav { background: #e91e63; color: white; }
        .btn-close { background: #333; color: #fff; margin-top: 5px; }
        .btn-reload { background: #444; color: #fff; }
        .btn-warn { background: #d35400; color: #fff; }
        .btn-danger { background: #c0392b; color: #fff; }
        .btn-cancel { background: #555; color: #fff; }

        .setting-group { display: flex; flex-direction: column; gap: 8px; background: #222; padding: 12px; border-radius: 8px; }
        .setting-label { font-family: 'Montserrat', sans-serif; font-size: 0.9rem; color: #aaa; display: flex; justify-content: space-between; }
        input[type=range] { width: 100%; accent-color: #f0f0f0; cursor: pointer; }

        #trigger-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; }

        /* Delete Modal Specifics */
        #delete-preview-img { max-width: 200px; max-height: 200px; border-radius: 8px; margin: 10px auto; border: 2px solid #c0392b; }
        .delete-msg { color: #aaa; font-size: 0.9rem; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="app">
        <div id="loader">Curating memories...</div>
        
        <div id="photo-container">
            <img id="main-photo" src="" alt="Memory">
        </div>

        <div id="text-overlay">
            <div id="content-wrapper">
                <div id="poem-text"></div>
                <div id="author-text"></div>
            </div>
            <div id="date-display"></div>
        </div>

        <!-- Invisible Layer to catch taps -->
        <div id="trigger-layer"></div>

        <!-- MAIN MENU -->
        <div id="menu-overlay">
            <div id="menu-box">
                <div class="menu-title">Control Panel</div>
                
                <div class="setting-group">
                    <div class="setting-label"><span>Speed</span><span id="interval-display">30s</span></div>
                    <input type="range" id="interval-slider" min="10" max="240" step="10" value="30">
                </div>

                <button class="btn btn-fav" onclick="menuActions.favorite()">
                    <span>‚ù§Ô∏è</span> Favorite Photo
                </button>

                <button class="btn btn-danger" onclick="menuActions.confirmDelete()">
                    <span>üóëÔ∏è</span> Delete Photo
                </button>

                <div style="height: 1px; background: #333; margin: 5px 0;"></div>

                <button class="btn btn-warn" onclick="menuActions.reindex()"><span>‚ö†Ô∏è</span> Full Re-index</button>
                <button class="btn btn-reload" onclick="menuActions.reload()"><span>‚Üª</span> Reload App</button>
                <button class="btn btn-danger" onclick="menuActions.exit()"><span>‚èª</span> Exit App</button>
                <button class="btn btn-close" onclick="menuActions.close()">Close</button>
            </div>
        </div>

        <!-- DELETE CONFIRMATION MODAL -->
        <div id="delete-confirm-overlay">
            <div id="menu-box">
                <div class="menu-title" style="color:#c0392b">Delete Photo?</div>
                <div class="delete-msg">This cannot be undone.</div>
                <img id="delete-preview-img" src="" />
                
                <button class="btn btn-danger" onclick="menuActions.doDelete()">Confirm Delete</button>
                <button class="btn btn-cancel" onclick="menuActions.cancelDelete()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const DEFAULT_INTERVAL = 30000;
        let currentInterval = parseInt(localStorage.getItem('photo_interval')) || DEFAULT_INTERVAL;
        let nextMemoryPromise = null;
        let displayTimer = null;
        let currentMemory = null; // Stores current photo data for actions

        // Elements
        const photoEl = document.getElementById('main-photo');
        const poemEl = document.getElementById('poem-text');
        const authorEl = document.getElementById('author-text');
        const dateEl = document.getElementById('date-display');
        const loaderEl = document.getElementById('loader');
        const menuOverlay = document.getElementById('menu-overlay');
        const deleteOverlay = document.getElementById('delete-confirm-overlay');
        const deletePreviewEl = document.getElementById('delete-preview-img');
        const sliderEl = document.getElementById('interval-slider');
        const intervalDisplayEl = document.getElementById('interval-display');

        // Init Slider
        sliderEl.value = currentInterval / 1000;
        intervalDisplayEl.innerText = `${sliderEl.value}s`;

        // --- CORE LOGIC ---

        async function fetchNextMemory() {
            try {
                const response = await fetch('/api/next-memory');
                if (!response.ok) throw new Error('Network error');
                const data = await response.json();
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.src = `/api/image?path=${data.imagePathEncoded}`;
                    img.onload = () => resolve({ ...data, imageSrc: img.src });
                    img.onerror = () => reject("Image load failed");
                });
            } catch (error) {
                console.error("Preload failed, retrying in 5s...", error);
                await new Promise(r => setTimeout(r, 5000));
                return fetchNextMemory(); 
            }
        }

        async function updateDisplay() {
            try {
                if (displayTimer) clearTimeout(displayTimer);
                if (!nextMemoryPromise) nextMemoryPromise = fetchNextMemory();
                
                const memory = await nextMemoryPromise;
                currentMemory = memory; 

                // Fade Out
                photoEl.style.opacity = 0;
                poemEl.style.opacity = 0;
                authorEl.style.opacity = 0;
                dateEl.style.opacity = 0;
                await new Promise(r => setTimeout(r, 1000));

                // Swap
                photoEl.src = memory.imageSrc;
                poemEl.innerText = `"${memory.text}"`;
                
                // Handle Author & Error Colors
                if (memory.type === 'quote' && memory.author) {
                    authorEl.innerText = memory.author === 'System Alert' ? memory.author : `- ${memory.author}`;
                    authorEl.style.display = 'block';
                    if (memory.author === 'System Alert') {
                        poemEl.style.color = '#ff6b6b'; authorEl.style.color = '#ff6b6b';
                    } else {
                        poemEl.style.color = '#f0f0f0'; authorEl.style.color = '#aaa';  
                    }
                } else {
                    authorEl.style.display = 'none';
                    poemEl.style.color = '#f0f0f0';
                }

                const dateObj = new Date(memory.date);
                if (dateObj.getFullYear() > 1980) {
                    dateEl.innerText = dateObj.toLocaleDateString('pt-PT', { year: 'numeric', month: 'long', day: 'numeric' }).toUpperCase();
                } else {
                    dateEl.innerText = ""; 
                }

                loaderEl.style.opacity = 0;
                
                // Fade In
                photoEl.style.opacity = 1;
                poemEl.style.opacity = 1;
                if (memory.type === 'quote') authorEl.style.opacity = 1;
                dateEl.style.opacity = 1;

                // Queue next
                nextMemoryPromise = fetchNextMemory();
                displayTimer = setTimeout(updateDisplay, currentInterval);
            } catch (error) {
                console.error("Display update failed:", error);
                displayTimer = setTimeout(updateDisplay, 5000);
            }
        }

        // --- INTERACTION HANDLERS ---

        document.getElementById('trigger-layer').addEventListener('pointerdown', () => {
            menuOverlay.classList.add('overlay-visible');
        });

        menuOverlay.addEventListener('click', (e) => { 
            if (e.target === menuOverlay) menuActions.close(); 
        });
        
        sliderEl.addEventListener('input', (e) => {
            const seconds = e.target.value;
            intervalDisplayEl.innerText = `${seconds}s`;
            currentInterval = seconds * 1000;
            localStorage.setItem('photo_interval', currentInterval);
        });

        const menuActions = {
            close: () => menuOverlay.classList.remove('overlay-visible'),
            
            favorite: async () => {
                if (!currentMemory) return;
                try {
                    const currentPath = decodeURIComponent(currentMemory.imagePathEncoded);
                    const res = await fetch('/api/favorite', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ currentPath })
                    });
                    const data = await res.json();
                    if (data.success) {
                        alert("‚ù§Ô∏è Photo added to favorites!");
                        menuActions.close();
                    } else {
                        alert("Error: " + (data.error || data.message));
                    }
                } catch(e) { alert("Failed to favorite."); }
            },

            confirmDelete: () => {
                if (!currentMemory) return;
                menuActions.close();
                deletePreviewEl.src = currentMemory.imageSrc;
                deleteOverlay.classList.add('overlay-visible');
            },

            cancelDelete: () => deleteOverlay.classList.remove('overlay-visible'),

            doDelete: async () => {
                if (!currentMemory) return;
                try {
                    const currentPath = decodeURIComponent(currentMemory.imagePathEncoded);
                    const res = await fetch('/api/photo', {
                        method: 'DELETE',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ currentPath })
                    });
                    
                    if (res.ok) {
                        menuActions.cancelDelete();
                        loaderEl.style.opacity = 1; 
                        loaderEl.innerText = "Deleting...";
                        nextMemoryPromise = null; 
                        updateDisplay();
                    } else {
                        const errData = await res.json();
                        alert("Failed to delete: " + (errData.error || "Unknown error"));
                    }
                } catch(e) { alert("Error deleting file: " + e.message); }
            },

            reindex: async () => {
                if (confirm("Re-index Library?")) {
                    menuActions.close();
                    loaderEl.style.opacity = 1; loaderEl.innerText = "Re-indexing...";
                    try { await fetch('/api/reindex', { method: 'POST' }); } catch (e) {}
                    setTimeout(() => loaderEl.innerText = "", 5000);
                }
            },
            reload: () => window.location.reload(),
            exit: async () => {
                if (confirm("Exit Application?")) {
                    await fetch('/api/exit', { method: 'POST' });
                    document.body.innerHTML = "<h1 style='color:white;text-align:center;margin-top:20%'>Shutting Down...</h1>";
                }
            }
        };

        // Start App
        updateDisplay();
    </script>
</body>
</html>