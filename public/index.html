<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poetic Memories</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;1,300&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            font-family: 'Merriweather', serif;
            user-select: none;
        }

        #app {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* PHOTO LAYER */
        #photo-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        #main-photo {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
        }

        /* TEXT LAYER (Overlay) */
        #text-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            min-height: 25vh; 
            background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.6) 60%, rgba(0,0,0,0) 100%);
            display: flex;
            flex-direction: column;
            justify-content: flex-end; 
            align-items: center;
            padding-bottom: 20px;
            z-index: 10;
            pointer-events: none;
        }

        #content-wrapper {
            width: 80%; 
            text-align: center;
            margin-bottom: 30px; 
            pointer-events: none;
        }

        #poem-text {
            font-size: 1.8rem;
            font-style: italic;
            line-height: 1.4;
            color: #f0f0f0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            opacity: 0;
            transition: opacity 2s ease-in-out 0.5s;
        }

        #author-text {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 15px;
            opacity: 0;
            transition: opacity 2s ease-in-out 0.8s;
        }

        /* DATE DISPLAY */
        #date-display {
            position: absolute;
            bottom: 25px;
            right: 30px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            color: #888;
            letter-spacing: 1px;
            opacity: 0;
            transition: opacity 2s ease-in-out 1s;
        }

        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            font-family: sans-serif;
            transition: opacity 0.5s;
        }

        /* --- MENU STYLES --- */
        #menu-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #menu-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #menu-box {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 280px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        .menu-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2rem;
            color: #fff;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Slider Styling */
        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #222;
            padding: 15px;
            border-radius: 8px;
        }

        .setting-label {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            color: #aaa;
            display: flex;
            justify-content: space-between;
        }

        input[type=range] {
            width: 100%;
            cursor: pointer;
            accent-color: #f0f0f0;
        }

        /* Buttons */
        .btn {
            padding: 15px 20px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
        }

        .btn:active { transform: scale(0.98); }
        .btn-close { background: #333; color: #fff; margin-top: 5px; }
        .btn-reload { background: #444; color: #fff; }
        .btn-warn { background: #d35400; color: #fff; }
        .btn-danger { background: #c0392b; color: #fff; }

        #trigger-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50; 
        }
    </style>
</head>
<body>

    <div id="app">
        <div id="loader">Curating memories...</div>
        
        <div id="photo-container">
            <img id="main-photo" src="" alt="Memory">
        </div>

        <div id="text-overlay">
            <div id="content-wrapper">
                <div id="poem-text"></div>
                <div id="author-text"></div>
            </div>
            <div id="date-display"></div>
        </div>

        <!-- Invisible Trigger -->
        <div id="trigger-layer"></div>

        <!-- Menu -->
        <div id="menu-overlay">
            <div id="menu-box">
                <div class="menu-title">Settings</div>
                
                <!-- Interval Slider -->
                <div class="setting-group">
                    <div class="setting-label">
                        <span>Speed</span>
                        <span id="interval-display">30s</span>
                    </div>
                    <input type="range" id="interval-slider" min="10" max="240" step="10" value="30">
                </div>

                <button class="btn btn-warn" onclick="menuActions.reindex()">
                    <span>⚠️</span> Full Re-index
                </button>
                
                <button class="btn btn-reload" onclick="menuActions.reload()">
                    <span>↻</span> Reload App
                </button>

                <button class="btn btn-danger" onclick="menuActions.exit()">
                    <span>⏻</span> Exit App
                </button>

                <button class="btn btn-close" onclick="menuActions.close()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION & STATE ---
        const DEFAULT_INTERVAL = 30000;
        
        // Load saved preference or default
        let currentInterval = parseInt(localStorage.getItem('photo_interval')) || DEFAULT_INTERVAL;
        let nextMemoryPromise = null;
        let displayTimer = null; // Handle for the timeout

        // DOM Elements
        const photoEl = document.getElementById('main-photo');
        const poemEl = document.getElementById('poem-text');
        const authorEl = document.getElementById('author-text');
        const dateEl = document.getElementById('date-display');
        const loaderEl = document.getElementById('loader');
        const menuOverlay = document.getElementById('menu-overlay');
        const triggerLayer = document.getElementById('trigger-layer');
        
        // Settings Elements
        const sliderEl = document.getElementById('interval-slider');
        const intervalDisplayEl = document.getElementById('interval-display');

        // Initialize Slider
        sliderEl.value = currentInterval / 1000;
        intervalDisplayEl.innerText = `${sliderEl.value}s`;

        // --- CORE LOGIC ---

        async function fetchNextMemory() {
            try {
                const response = await fetch('/api/next-memory');
                if (!response.ok) throw new Error('Network error');
                const data = await response.json();

                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.src = `/api/image?path=${data.imagePathEncoded}`;
                    img.onload = () => resolve({ ...data, imageSrc: img.src });
                    img.onerror = () => reject("Image load failed");
                });
            } catch (error) {
                console.error("Preload failed, retrying in 5s...", error);
                await new Promise(r => setTimeout(r, 5000));
                return fetchNextMemory(); 
            }
        }

        async function updateDisplay() {
            try {
                // Clear any pending timer to avoid overlaps
                if (displayTimer) clearTimeout(displayTimer);

                if (!nextMemoryPromise) nextMemoryPromise = fetchNextMemory();
                const memory = await nextMemoryPromise;

                // Fade Out
                photoEl.style.opacity = 0;
                poemEl.style.opacity = 0;
                authorEl.style.opacity = 0;
                dateEl.style.opacity = 0;

                await new Promise(r => setTimeout(r, 1000));

                // Swap Content
                photoEl.src = memory.imageSrc;
                poemEl.innerText = `"${memory.text}"`;
                
                if (memory.type === 'quote' && memory.author) {
                    authorEl.innerText = memory.author === 'System Alert' 
                        ? memory.author 
                        : `- ${memory.author}`;
                    authorEl.style.display = 'block';

                    if (memory.author === 'System Alert') {
                        poemEl.style.color = '#ff6b6b'; 
                        authorEl.style.color = '#ff6b6b';
                    } else {
                        poemEl.style.color = '#f0f0f0'; 
                        authorEl.style.color = '#aaa';  
                    }
                } else {
                    authorEl.style.display = 'none';
                    poemEl.style.color = '#f0f0f0';
                }

                const dateObj = new Date(memory.date);
                if (dateObj.getFullYear() > 1980) {
                    dateEl.innerText = dateObj.toLocaleDateString('pt-PT', { 
                        year: 'numeric', month: 'long', day: 'numeric' 
                    }).toUpperCase();
                } else {
                    dateEl.innerText = ""; 
                }

                loaderEl.style.opacity = 0;

                // Fade In
                photoEl.style.opacity = 1;
                poemEl.style.opacity = 1;
                if (memory.type === 'quote') authorEl.style.opacity = 1;
                dateEl.style.opacity = 1;

                // Prepare next memory
                nextMemoryPromise = fetchNextMemory();

                // Schedule next update using the DYNAMIC interval
                displayTimer = setTimeout(updateDisplay, currentInterval);

            } catch (error) {
                console.error("Display update failed:", error);
                // Retry sooner if error
                displayTimer = setTimeout(updateDisplay, 5000);
            }
        }

        // --- MENU & INTERACTIONS ---

        triggerLayer.addEventListener('pointerdown', () => {
            menuOverlay.classList.add('visible');
        });

        menuOverlay.addEventListener('click', (e) => {
            if (e.target === menuOverlay) menuActions.close();
        });

        // Slider Logic
        sliderEl.addEventListener('input', (e) => {
            const seconds = e.target.value;
            intervalDisplayEl.innerText = `${seconds}s`;
            currentInterval = seconds * 1000;
            localStorage.setItem('photo_interval', currentInterval);
            // Note: We don't restart the timer immediately here to keep it smooth,
            // but the NEXT cycle will pick up this new speed.
        });

        const menuActions = {
            close: () => {
                menuOverlay.classList.remove('visible');
            },
            reindex: async () => {
                if (confirm("Re-index Library? This will clear the cache.")) {
                    menuActions.close();
                    loaderEl.style.opacity = 1;
                    loaderEl.innerText = "Re-indexing Library...";
                    try { await fetch('/api/reindex', { method: 'POST' }); } 
                    catch (e) { alert("Error."); }
                    setTimeout(() => loaderEl.innerText = "", 5000);
                }
            },
            reload: () => window.location.reload(),
            exit: async () => {
                if (confirm("Exit Application?")) {
                    await fetch('/api/exit', { method: 'POST' });
                    document.body.innerHTML = "<h1 style='color:white;text-align:center;margin-top:20%'>Shutting Down...</h1>";
                }
            }
        };

        // Start Loop
        updateDisplay();

    </script>
</body>
</html>